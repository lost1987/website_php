<?php
/**
 * Created by PhpStorm.
 * User: shameless
 * Date: 15/7/1
 * Time: 下午2:38
 * 定时任务分配类
 */

    $args = getopt('n:');
    $className = $args['n'];

    define( 'BASE_PATH' , dirname( __FILE__ ) );
    define( 'BASE_PROJECT' , $className );
    error_reporting( E_ALL & ~E_NOTICE );
    ini_set( 'display_errors' , 'off' );

    require BASE_PATH . '/core/autoload.class.php';
    require BASE_PATH . '/core/db.class.php';

    /*定义动态加载类*/
    spl_autoload_register( array( 'Autoload' , 'load' ) );

    /*设置时区***/
    date_default_timezone_set( "Asia/Shanghai" );

    /*启动错误日志*/
    \utils\DateLog::instance( BASE_PATH . '/logs' , BASE_PROJECT )->on();

    /*定义全局异常处理*/
    set_exception_handler( array( \core\ExceptionHandler::instance() , 'handle' ) );

    /*全局错误处理 将错误托管给异常处理*/
    set_error_handler( array( \core\ExceptionHandler::instance() , 'error_transfer_exception' ) );

    $cfg = require BASE_PATH . '/conf/global.inc.php';

    //链接redis
    $r = new \core\Redis($cfg['redis']['host'],$cfg['redis']['port']);
    $redis = $r->getResource();
    $redis->select($cfg['redis']['idx']);
    $pid  = getmypid();
    $redis->set($cfg['daemon_prefix'].$className,$pid);

    $scope = new \core\Scope();
    $scope -> cfg = $cfg;
    $scope-> redis = $redis;
    $className = 'run\\'.ucfirst($className);
    $class = new $className;
    if($class instanceof \interfaces\IExecutable)
            $class -> execute($scope);
    else
        die('可执行定时任务实例必须是\interfaces\IExecutable的子类!');

